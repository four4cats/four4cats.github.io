---
title: iOS ä½¿ç”¨ Jenkins å®ç°æŒç»­é›†æˆ
date: 2020-03-29 14:43:39
description: Jenkins - iOS å‡ºå‘æŒ‡å—
author: TimorYang
categories: 
 - iOS
tags: iOS, Jenkins, fastlane, infer, CI/CD
---

# iOS ä½¿ç”¨ Jenkins å®ç°æŒç»­é›†æˆ

### Jenkins åˆæ¢
>æ¯å½“åŠŸèƒ½å¼€å‘å‘¨æœŸç»“æŸåï¼Œå°±ä¼šé™·å…¥ **Fix bug** å’Œ**æ‰“åŒ…**çš„æ— é™å¾ªç¯ä¸­ï¼Œæˆ‘å½“æ—¶å°±åœ¨æƒ³ï¼Œå¦‚æœæŠŠæ‰“åŒ…è¿™æ ·çš„é‡å¤æ€§å·¥ä½œäº¤ç»™ç”µè„‘æ¥åš,æˆ‘å°±æœ‰å¯ä»¥åˆ©ç”¨èŠ‚çœä¸‹æ¥çš„è¿™äº›ç¢ç‰‡æ—¶é—´æ¥ç ”ç©¶å…¶ä»–æœ‰è¶£çš„äº‹æƒ…ã€‚æ—©å¹´åœ¨ä¸­å›½ç§»åŠ¨å·¥ä½œçš„æ—¶å€™å°±æ¥è§¦åˆ°äº† Jenkinsï¼Œä½†ä¸€ç›´æ²¡æœ‰å»æ·±å…¥äº†è§£è¿‡ï¼Œè¿™ä¸€æ¬¡ç®—æ˜¯åœ¨å‘é‡Œè¶Ÿäº†ä¸€éï¼Œå°±å†™ä¸‹äº†è¿™ç¯‡ Jenkins ä¹‹ iOS å‡ºå‘æŒ‡å—ã€‚

æ¥ä¸‹æ¥é˜è¿°ä¸‹æˆ‘çš„æ€è·¯ï¼Œå…¶å®å¾ˆç®€å•ï¼Œæˆ‘å°±æ˜¯ä½¿ç”¨ Jenkins æŠŠç›®å‰å·¥ä½œä¸­æ‰€ç”¨åˆ°çš„æµç¨‹ä¸²èµ·æ¥äº†ã€‚
1. è·å– Github(ä¹Ÿå¯ä»¥æ˜¯åŸºäº Git çš„å…¶ä»–æœåŠ¡å•†ï¼Œæˆ–è€…æ˜¯ SVN) çš„æœ€æ–°ä»£ç 
2. ç¼–è¯‘ä»£ç 
3. UT & UITest
4. Static code analysis
5. Archive(è¿™ä¸€æ­¥ä¸ä»…ä»…æ˜¯æ‰“åŒ…ï¼Œä½¿ç”¨ [fastlane](fastlane) åšåˆ°äº†ï¼Œè‡ªåŠ¨ä¸Šä¼  AppStoreï¼ŒTestFight åˆ†å‘)

è™½ç„¶çœ‹ä¸Šå»åªæœ‰ç®€ç®€å•å•çš„ 5 æ­¥ï¼Œä½†ç¡®å®å¯ä»¥ç”¨â€œä¸€æ­¥ä¸€ä¸ªå‘â€æ¥å½¢å®¹ï¼Œä¸€ç‚¹ä¹Ÿä¸é¡ºåˆ©ã€‚
ç°åœ¨æ€è·¯ï¼Œæµç¨‹éƒ½æƒ³å¥½äº†ï¼Œé‚£ä¹ˆæ¥ä¸‹æ¥å°±æ˜¯è€ƒè™‘æ€ä¹ˆç”¨ Jenkins å®ç°äº†ã€‚
### å®ç°æ–¹æ¡ˆ
ä»”ç»†å“å“ä¸Šé¢çš„æ‰€è¯´çš„è¿™äº”ä¸ªæ­¥éª¤ï¼Œå…¶å®å®ƒä»¬ä¹‹é—´æœ‰ç€ä¾èµ–å…³ç³»ï¼Œå¦‚æœè¯´ä½ åœ¨æ‹‰å»æœ€æ–°ä»£ç çš„æ—¶å€™å°±å¤±è´¥äº†ï¼Œä¸‹é¢ 2ï¼Œ3ï¼Œ4...çš„è¿™äº›æ­¥éª¤å°±æ²¡æœ‰å¿…è¦å»æ‰§è¡Œäº†ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æŠŠè¿™ 5 ä¸ªæ­¥éª¤å¯¹åº”æˆ Jenkins é‡Œé¢çš„ 5 ä¸ª Jobï¼Œç¬¬ä¸€ä¸ª Job çš„åŠŸèƒ½å°±æ˜¯è´Ÿè´£æ‹‰å–æœ€æ–°ä»£ç ï¼Œç¬¬äºŒä¸ª job å°±æ˜¯ç¼–è¯‘ä»£ç ï¼Œä»¥æ­¤ç±»æ¨ã€‚åŒæ—¶æˆ‘åˆå¸Œæœ›å¦‚æœæŸä¸€ä¸ª Job æ‰§è¡Œå¤±è´¥äº†ï¼Œä¼šé€šè¿‡é‚®ä»¶æˆ–è€…å…¶ä»–çš„æ–¹å¼é€šçŸ¥åˆ°æˆ‘ä»¬ï¼Œè®©æˆ‘ä»¬åŠæ—¶æ’é™¤é—®é¢˜ï¼Œè®©æ•´ä¸ªæµç¨‹åˆå¯ä»¥ç»§ç»­è·‘ä¸‹å»ã€‚å½“è·‘å®Œæ•´ä¸ªæµç¨‹åï¼Œæˆ‘è¿˜å¸Œæœ›æŒç»­é›†æˆäº§å‡ºçš„IPA(æˆ–è€…æ˜¯ jarï¼Œapk ç­‰ç­‰)å¯ä»¥æ”¾åˆ°æˆ‘ä»¬æŒ‡å®šçš„ FTP æœåŠ¡å™¨ä¸‹é¢ï¼Œå¹¶é€šè¿‡é‚®ä»¶å‘ŠçŸ¥æˆ‘ä»¬æ‰“åŒ…å®Œæˆå¯ä»¥å¼€å§‹æ–°çš„æµ‹è¯•äº†ã€‚
æ”¾åˆ°æŒ‡å®šçš„åœ°æ–¹ï¼Œæ˜¯å› ä¸ºå½“æŸä¸ªç‰ˆæœ¬å‡ºæ¥é—®é¢˜ï¼Œå¯ä»¥åŠæ—¶æ‰¾åˆ°å¯¹åº”çš„dSYMï¼ˆ[Debug symbol](https://en.wikipedia.org/wiki/Debug_symbol)ï¼‰æ–‡ä»¶ï¼Œç¬¦å·ä½ crash æ–‡ä»¶ï¼Œæé«˜äº†å®šä½é—®é¢˜çš„æ•ˆç‡ã€‚å½“ç„¶å½’çº³çš„å¥½å¤„å¹¶ä¸æ­¢è¿™ä¸€ç‚¹ï¼Œæˆ‘è¿™é‡Œå°±ä¸å±•å¼€å™è¿°äº†ã€‚
#### Job ä¾èµ–
ä¸ºäº†å®ç°æˆ‘ä»¬åˆšåˆšæ‰€è¯´çš„ä¾èµ–å…³ç³»ï¼Œæˆ‘æŸ¥çœ‹äº† Jenkins æ–‡æ¡£ï¼ŒJenkins é‡Œé¢æœ‰ä¸ª**ä¸Šä¸‹æ¸¸**çš„æ¦‚å¿µï¼Œä¸¾ä¸ªä¾‹å­ Job A æ‰§è¡ŒæˆåŠŸéœ€è¦è§¦å‘ Job Bï¼Œé‚£ä¹ˆ Job A å°±æ˜¯ Job B çš„ä¸Šæ¸¸ï¼Œåè¿‡æ¥ï¼ŒJob B å°±æ˜¯ Job A çš„ä¸‹æ¸¸ã€‚

*++æ€ä¹ˆå®ç°ä¸Šä¸‹æ¸¸å‘¢ï¼Ÿ++*
##### Plan A
åœ¨ Jenkins é‡Œé¢æ¯ä¸€ä¸ª Job çš„é…ç½®é‡Œéƒ½æœ‰**Build after other projects are built**è¿™ä¸ªé€‰é¡¹ï¼Œæˆ‘ä»¬åœ¨è¿™é‡Œå¡«å†™ä¾èµ–çš„ä¸Šæ¸¸ Job åç§°ã€‚
ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹

##### Plan B
Jenkins Plugin: [Parameterized Trigger](https://plugins.jenkins.io/parameterized-trigger/)
ä½¿ç”¨è¿™ä¸ªæ’ä»¶ï¼Œæˆ‘ä»¬åœ¨å»ºç«‹ä¾èµ–å…³ç³»çš„åŒæ—¶è¿˜èƒ½å¾€ä¸‹æ¸¸ä¼ é€’å‚æ•°è®©ä¸‹æ¸¸ Job å¯ä»¥æ ¹æ®ä¸åŒçš„æ¡ä»¶æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚
ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š
Job A
Job B

ä»¥ä¸Šä¸¤ç§æ–¹æ¡ˆï¼ŒæŒ‰éœ€ä½¿ç”¨ã€‚
è¿™é‡Œæ ¹æ®éœ€æ±‚ï¼Œæˆ‘é€‰ç”¨çš„æ˜¯ Plan Bï¼Œå› ä¸º Jenkins çš„æ¯ä¸€ä¸ª Job çš„ workspace éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œè€Œæˆ‘è®¾è®¡çš„æ•´ä¸ªæŒç»­é›†æˆçš„æµç¨‹å…¶å®ä½œç”¨çš„å¯¹è±¡æ˜¯åŒä¸€ä¸ªï¼Œsoï¼Œæˆ‘å¸Œæœ›æ‰€æœ‰çš„ Job éƒ½æ˜¯åœ¨åŒä¸€ä¸ª workspace é‡Œé¢è¿è¡Œï¼Œç†æ‰€å½“ç„¶æˆ‘éœ€è¦æŠŠ workspace çš„ç»å¯¹è·¯å¾„ä½œä¸ºå‚æ•°ä¼ ç»™ä¸‹æ¸¸ Jobï¼Œæ¥è¾¾åˆ°è®©æ‰€æœ‰çš„ Job ä½œç”¨çš„å¯¹è±¡éƒ½æ˜¯åŒä¸€ä¸ªã€‚
ç°åœ¨ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆå®¹æ˜“çš„å°†ä¸Šé¢æ‰€è¯´çš„è¿™ 5 ä¸ªæ­¥éª¤ä¸²èµ·æ¥ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬éœ€è¦å®ç°æ¯ä¸€ä¸ª Job éœ€è¦åšçš„äº‹æƒ…ã€‚
#### Step 1 è·å–æœ€æ–°ä»£ç 
é€šç”¨é…ç½®
* æ£€æŸ¥ Jenkins çš„è®¾ç½®é‡Œé¢æ˜¯å¦æ­£ç¡®é…ç½®äº† Git ç¯å¢ƒï¼Œå¦‚æœæ²¡æœ‰æ­£ç¡®é…ç½®ï¼Œä¼šæŠ¥**å¾…å¡«**è¿™ä¸ªé”™è¯¯
* é…ç½® Git è¶…æ—¶æ—¶é—´ï¼Œå¦‚æœé¡¹ç›®å·¥ç¨‹æ¯”è¾ƒå¤§ï¼ŒåŠ ä¸Šç½‘ç»œä¸æ˜¯å¾ˆé¡ºç•…ï¼Œå¾ˆå®¹æ˜“å‡ºç°é»˜è®¤çš„ 10 åˆ†é’Ÿè¶…æ—¶æ‹‰å–å¤±è´¥çš„é”™è¯¯
* é…ç½® webhook (Push, Pull Request, more...)

ç‰¹æ®Šéœ€æ±‚
* Jenkins éœ€è¦æ‹‰å–å¤šä¸ªåˆ†æ”¯çš„ä»£ç 

ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š
1. é…ç½®é¡¹ç›®åœ°å€
2. é…ç½®ä»“åº“åœ°å€ï¼Œå¦‚æœæ˜¯ç§æœ‰ä»“åº“ï¼Œéœ€é…ç½®è´¦å·å¯†ç æˆ–è€… SSH å¯†é’¥
3. è¿™é‡Œæˆ‘ä½¿ç”¨ Job ä¾èµ–çš„ Plan B æ–¹æ¡ˆï¼Œä¼ é€’**branch_ref**å’Œ**workspace**ä¸¤ä¸ªå‚æ•°
4. è§¦å‘ä¸‹æ¸¸ Job

#### Step 2 ç¼–è¯‘ä»£ç 
è¿™ä¸€æ­¥ï¼Œæˆ‘ä»¬ä½¿ç”¨ [xcodebuild](https://developer.apple.com/library/archive/technotes/tn2339/_index.html) å‘½ä»¤æ¥ç¼–è¯‘æˆ‘ä»¬çš„é¡¹ç›®å·¥ç¨‹ä»£ç ã€‚è¿™é‡Œä½¿ç”¨çš„æ¯”è¾ƒç®€å•ï¼Œæ›´å¤šå…³äº xcodebuild çš„ä½¿ç”¨æ–¹æ³•ï¼Œè¯·çœ‹å®˜æ–¹æ–‡æ¡£ã€‚
``` shell
# å¦‚æœæ˜¯å«æœ‰ Pods å·¥ç¨‹
pod install
xcodebuild -workspace xxx.xcworkspace -scheme xxx
# å¦‚æœä¸å« Pods å·¥ç¨‹
xcodebuild -project xxx.xcodeproj -scheme xxx
```
è¿™ä¸€æ­¥ä¸»è¦æ˜¯ä¸ºäº†ç¡®è®¤å½“å‰æœ€æ–°çš„ä»£ç æ˜¯å¦èƒ½ç¼–è¯‘é€šè¿‡ï¼Œå¦‚æœä¸èƒ½ç¼–è¯‘é€šè¿‡ï¼ŒJenkins ä¼šé€šè¿‡ Email çš„æ–¹å¼é€šçŸ¥å¼€å‘è€…ï¼Œè®©å¼€å‘è€…æ¥è§£å†³å½“å‰æœ€æ–°ä»£ç æ— æ³•ç¼–è¯‘é€šè¿‡çš„é—®é¢˜ã€‚
è¿™ä¸ª Job ä¸ä¼šäº§ç”Ÿä»»ä½•çš„å‚æ•°ï¼Œæ‰€ä»¥æˆ‘ä»¬åªéœ€è¦å°†ä¸Šæ¸¸ Job ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œç»§ç»­ä¼ ç»™ä¸‹æ¸¸é¡¹ç›®ã€‚

#### Step 3 UT & UITest
++ç›®å‰æˆ‘ä»¬é¡¹ç›®çš„å•å…ƒæµ‹è¯•å’Œ UITestè¿˜åœ¨ coding é˜¶æ®µï¼Œæ‰€ä»¥è¿™ä¸€æ­¥æš‚ä¸å®ç°ã€‚++
#### Step 4 Static code analysis
> Static code analysis ç›®å‰ä¸»æµçš„å·¥å…·æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯ [OCLint](http://oclint.org) è¿˜æœ‰ä¸€ä¸ªæ˜¯ [Infer](https://fbinfer.com)(Facebook å¼€æº)ã€‚

æˆ‘è¿™é‡Œé€‰ç”¨äº† Infer æ¥åš Static code analysisï¼Œå¹¶é…åˆ Jenkins PMD Plugin æ¥åšåˆ†ææŠ¥å‘Šçš„å¯è§†åŒ–ã€‚
``` shell
# Infer å®‰è£…
brew install infer
# Start static code analysis
# Podså·¥ç¨‹
infer run -- xcodebuild -workspace xxx.xcworkspace -scheme xxx -configuration Debug -sdk iphonesimulator
# é Pods å·¥ç¨‹
infer run -- xcodebuild -project xxx.xcodeproj -scheme xxx -configuration Debug -sdk iphonesimulator
```
é…ç½® PMD Plugin
**å›¾ç‰‡ï¼Œ å¾…å¡«**

å½“åˆ†æç»“æœå‡ºæ¥åï¼Œä½¿ç”¨ Jenkins å°†å½“å‰çš„ç»“æœé€šè¿‡ Email å‘é€ç»™å¼€å‘åŒå­¦ï¼Œé€šçŸ¥å¼€å‘åŒå­¦å°½å¿«ä¿®å¤å­˜åœ¨éšæ‚£çš„ä»£ç ã€‚

åŒæ ·çš„ï¼Œè¿™é‡Œæˆ‘ä»¬è¿˜æ˜¯ç»§ç»­å°†ä¸Šæ¸¸ä¼ é€’è¿‡æ¥çš„å‚æ•°ï¼Œç»§ç»­ä¼ ç»™ä¸‹æ¸¸é¡¹ç›®ï¼Œä¸åšä»»ä½•ä¿®æ”¹ã€‚
#### Step 5 Archive
> fastlane, App automation done right. The easiest way to build and release mobile apps.
> fastlane handles tedious tasks so you donâ€™t have to.

æˆ‘ä»¬åˆ©ç”¨å¼ºå¤§çš„å¼€æºç¤¾åŒºæä¾›çš„å·¥å…·**fastlane**æ¥å®Œæˆæœ€åä¸€æ­¥æ‰“åŒ…å’Œåˆ†å‘ã€‚
å®‰è£… fastlane
``` shell
# Using RubyGems
sudo gem install fastlane -NV

# Alternatively using Homebrew
brew install fastlane
```
åˆå§‹åŒ–é¡¹ç›®
``` shell
# Objective-C
fastlane init

# swift
fastlane init swift
```
é…ç½® fastlane file
**è¿™é‡Œå»ºè®®ç¬¬ä¸€æ¬¡æ¥è§¦ fastlane çš„å°ä¼™ä¼´ï¼Œä»”ç»†é˜…è¯» fastlane çš„[æ–‡æ¡£](https://docs.fastlane.tools)ã€‚**
æœ€ç»ˆçš„æ‰§è¡Œå‘½ä»¤
```
# ä¸Šæ¸¸ä¼ é€’çš„å‚æ•° branch_name
if [ branch_name = "master"]
then;
	# æäº¤è‹¹æœå•†åº—
	fastlane release
fi

if [ branch_name = "release"]
then;
	# æäº¤åˆ° TestFlight
	fastlane beate
fi

# å¦‚æœæ˜¯ dev åˆ†æ”¯ï¼Œå°±ä»€ä¹ˆéƒ½ä¸åš
```

å½“ Archive Job æˆåŠŸåï¼ŒJenkins ä¼šé€šè¿‡ Email é€šçŸ¥æŠ€æœ¯éƒ¨é—¨çš„å…¨ä½“å°ä¼™ä¼´æ‰“åŒ…æˆåŠŸï¼Œå¯ä»¥å¼€å§‹æ–°çš„ä¸€è½®æµ‹è¯•äº†ã€‚

è‡³æ­¤ï¼Œæˆ‘ä»¬æ•´ä¸ªè‡ªåŠ¨åŒ–æµç¨‹å°±é…ç½®ç»“æŸäº†ï¼Œæˆ‘ä»¬å¯ä»¥åˆ©ç”¨è¿™ä¸ªæ—¶é—´å»ç ”ç©¶å…¶ä»–çš„äº‹æƒ…äº†ã€‚ğŸ»ğŸ‰ enjoy itã€‚

è¿™é‡Œè®°å½•ä¸‹æˆ‘åœ¨ fastlane é…ç½® match è¯ä¹¦é‡åˆ°çš„å‘

**Git Storage on GitHub**

If your machine is currently using SSH to authenticate with GitHub, you'll want to use a git URL, otherwise, you may see an authentication error when you attempt to use match. Alternatively, you can set a basic authorization for match:

`match(git_basic_authorization: '<YOUR KEY>')`
æ–‡æ¡£é‡Œæç¤ºä½¿ç”¨ä¸Šé¢çš„è¯­æ³•æ¥è¿›è¡Œ Github Personal access tokens çš„é…ç½®
ä½†æ˜¯æŒ‰ç…§æ–‡æ¡£çš„é…ç½®ï¼Œæ­»æ´»éƒ½ä¸èƒ½æˆåŠŸï¼Œæˆ‘åœ¨ fastlane çš„ issues ä¸­æ‰¾åˆ°äº†å¯¹åº”çš„è§£å†³æ–¹æ¡ˆ
* https://github.com/fastlane/fastlane/issues/15560
> I realized that this was not my problem. I didn't find in Fastlane documentation that I need to encode the token like Base64.encode64("myusername:mypersonaltoken") and use it as my basic auth token. Would be good if we update the docs and add this tip.

ğŸ‘†ä¸Šé¢åº”è¯¥æ˜¯ fastlane çš„å¼€å‘è€…å›å¤çš„ï¼Œè®©æˆ‘ä»¬ä½¿ç”¨`git_basic_authorization 'Base64.encode64("myusername:mypersonaltoken")'`æ¥é…ç½® match fileï¼Œå°è¯•äº†ä¸€æ³¢åï¼Œè¿˜æ˜¯å¤±è´¥äº†ï¼Œç„¶åæˆ‘æ¥ç€æŸ¥ issues, æ‰¾åˆ°äº†è¿™ä¸ª[è§£å†³æ–¹æ¡ˆ](https://github.com/fastlane/fastlane/issues/15560#issuecomment-548437763)ï¼Œå°†**Base64.encode64** æ”¹æˆ**Base64.strict_encode64**ï¼ŒAnd it works ğŸ‰ã€‚
### å†™åœ¨ç»“å°¾
å¦‚æœä½ ä¹Ÿåœ¨å°è¯•ä½¿ç”¨ CI/CD æ¥åšæŒç»­äº¤äº’ï¼Œé‡åˆ°äº†ä¸€äº›é—®é¢˜ï¼Œå¸Œæœ›ä½ ä¸è¦æ”¾å¼ƒï¼Œå½“ä½ ä»å‘é‡Œçˆ¬å‡ºæ¥åï¼Œä½ å°±ä¼šè·å¾—ç›¸å…³çš„ç»éªŒï¼Œå¸®åŠ©ä½ æˆé•¿ï¼Œå½“ä½ ä¸€ä¸ªäººè¢«ä¸€ä¸ªé—®é¢˜éš¾ä½å¾ˆä¹…çš„æ—¶å€™ï¼Œä¸å¦¨å…ˆæ–¹å‘æ‰‹å¤´çš„äº‹æƒ…ï¼Œèµ°ä¸€èµ°ï¼Œæ‹ä¸€æ‹æ€è·¯ï¼Œè¯´ä¸å®šå°±èŒ…å¡é¡¿å¼€äº†ã€‚ä½ ä¹Ÿå¯ä»¥åœ¨ä¸‹é¢ç»™æˆ‘ç•™è¨€ï¼Œæˆ‘ä»¬ä¸€èµ·è§£å†³ğŸ»ã€‚